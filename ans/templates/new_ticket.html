{% extends "base.html" %}

{% block content %}
<h1>Обращение #{{ ticket.id }}: {{ ticket.problem_name }}</h1>

<div class="ticket-info">
  <p><strong>Клиент:</strong> {{ ticket.name }}</p>
  <p><strong>Продукт:</strong> {{ ticket.product_name }}</p>
  <p><strong>Описание проблемы:</strong> {{ ticket.problem_full }}</p>
  <p><strong>Статус:</strong> {% if ticket.is_finished %}Закрыт{% else %}Активен{% endif %}</p>
  <button onclick="window.location.reload()" class="btn btn-secondary">Обновить сообщения</button>
  {% if not ticket.is_finished %}
  <button onclick="closeTicket({{ ticket.id }})" class="btn btn-danger">Закрыть тикет</button>
  {% endif %}
</div>

<div class="chat-container">
  {% for message in messages %}
  <div class="message {% if message.sender_type == 'client' %}user-message{% else %}support-message{% endif %}">
    <div class="message-content">
      {{ message.text }}
    </div>
    <div class="message-info">
      <span class="sender-name">{{ message.sender_name }}</span>
      <span class="message-time">{{ message.timestamp|datetime }}</span>
    </div>
  </div>
  {% endfor %}
</div>

{% if not ticket.is_finished %}
<div class="reply-form">
  <h3>Ответить на обращение</h3>
  <form action="{{ url_for('send_message', ticket_number=ticket.id) }}" method="post">
    <div class="form-group">
      <textarea name="text" class="form-control" rows="4" required></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Отправить</button>
  </form>
</div>
{% endif %}

<script>
  function closeTicket(ticketId) {
    if (confirm('Вы уверены, что хотите закрыть тикет?')) {
      fetch(`/api/close_ticket/${ticketId}`, {
        method: 'POST'
      }).then(() => {
        window.location.href = '/my_desk';
      });
    }
  }
</script>
{% endblock %}